<?

// cls :: devl - class definition
// --------------------------------------------------------------------------------------
   class devl
   {
   // pty :: attr - `devl` attributes
   // -----------------------------------------------------------------------------------
      private static $attr = 0;
   // -----------------------------------------------------------------------------------



   // fnc :: ini - initialize `devl`
   // -----------------------------------------------------------------------------------
      public static function ini()
      {
      // add :: to - call-stack
      // --------------------------------------------------------------------------------
         core::stack();
      // --------------------------------------------------------------------------------

      // set :: attr - `devl` attributes object
      // --------------------------------------------------------------------------------
         self::$attr = obj(['scope'=>core::get('conf.atrScope')]);
      // --------------------------------------------------------------------------------

      // def :: local - vars
      // --------------------------------------------------------------------------------
         $tdn = 'cfg/devl/tpl';
         $fdn = 'sys/devl/make';

         $tnl = scandir($tdn);
         $fnl = scandir($fdn);

         self::$attr->tmpl = obj();
      // --------------------------------------------------------------------------------

      // set :: attr - `tmpl` object
      // --------------------------------------------------------------------------------
         foreach ($tnl as $itm)
         {
            if ($itm[0] === '.'){ continue; }

            $nme = explode('.', $itm)[0];
            self::$attr->tmpl->$nme = file_get_contents(CWD."$tdn/$itm");
         }
      // --------------------------------------------------------------------------------

      // set :: make - functions
      // --------------------------------------------------------------------------------
         foreach ($fnl as $itm)
         {
            if ($itm[0] === '.'){ continue; }

            require_once(CWD."$fdn/$itm");
         }
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: make - create paths & insert their contents according to relevant templates
   // -----------------------------------------------------------------------------------
      public static function make($pth)
      {
      // add :: to - call-stack
      // --------------------------------------------------------------------------------
         core::stack();
      // --------------------------------------------------------------------------------

      // def :: local - vars
      // --------------------------------------------------------------------------------
         $pth = path::norm($pth);
         $inf = path::info($pth);
         $pts = explode('/',$pth);
         $cdr = (($pts[0] === 'sys') ? 'sys' : $pts[0].'/'.$pts[1]);
         $crp = explode($cdr,$pth)[1];
         $pts = explode('.',$crp);
         $ref = $pts[1];
         $crp = ltrim(str_replace('/','.', $pts[0]), '.');

         $pts = explode('.',$crp);
         $cls = array_shift($pts);
         $erp = implode($pts,'.');

         $src = (isset(self::$attr->tmpl->$ref) ? self::$attr->tmpl->$ref : udf);
         $fnc = (isset(self::$attr->make->$ref) ? self::$attr->make->$ref : udf);
      // --------------------------------------------------------------------------------

      // cnd :: debug - tmpl
      // --------------------------------------------------------------------------------
         if ($src === udf)
         { fail::{Src}("template for type: `$ref` is ".Udf); }
      // --------------------------------------------------------------------------------

      // cnd :: debug - make
      // --------------------------------------------------------------------------------
         if ($fnc === udf)
         { fail::{Src}("function for type: `$ref` is ".Udf); }
      // --------------------------------------------------------------------------------

      // add :: make - to inf object
      // --------------------------------------------------------------------------------
         $inf->make = obj
         ([
            'cls'=>$cls,
            'ref'=>$erp,
         ]);
      // --------------------------------------------------------------------------------

      // run :: call - handler with `$src` & `$inf`
      // --------------------------------------------------------------------------------
         $rsl = call_user_func_array($fnc,[$src,$inf]);
      // --------------------------------------------------------------------------------

      // run :: path.make - write entire path & text into path - will NOT over-write
      // --------------------------------------------------------------------------------
         path::make($pth,$rsl);
      // --------------------------------------------------------------------------------

      // rsl :: return - true
      // --------------------------------------------------------------------------------
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: tst - check if `devl.attr.ref` is valid
   // -----------------------------------------------------------------------------------
      public static function tst($ref)
      {
      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $cls = __CLASS__;
         $lst = explode('.',$ref);
         $ref = (($lst[0] === $cls) ? "$cls.$ref" : $ref);
         $pth = core::get('paths')[0];
         $stc = core::get('stack')[1];
         $fnc = explode('::', $stc->call)[1];
         $scp = self::$attr->scope;
         $arr = [];
      // --------------------------------------------------------------------------------

      // cnd :: fail - if `devl` is map's first item, on if `$ref` is invalid
      // --------------------------------------------------------------------------------
         if (($lst[0] === $cls) || ($ref[0] === '.') || (substr($ref,-1,1) === '.'))
         { fail::{Ref}("invalid reference: `$ref`"); }
      // --------------------------------------------------------------------------------

      // run :: loop - on map items
      // --------------------------------------------------------------------------------
         foreach ($lst as $itm)
         {
            $arr[] = $itm;
            $tgt = implode($arr, '.');

            if (isset($scp->bias->$tgt) && ($scp->bias->$tgt !== $pth))
            { fail::{'scope'}("`$cls.$tgt` is biased to `$pth`"); }

            if (isset($scp->lock->$tgt) && str($fnc)->is(['set','add','rip']))
            { fail::{'scope'}("`$cls.$tgt` is locked"); }
         }
      // --------------------------------------------------------------------------------

      // rsl :: true
      // --------------------------------------------------------------------------------
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: set - define `devl` attribute by ref
   // -----------------------------------------------------------------------------------
      public static function set($ref,$val)
      {
      // run :: stack & test
      // --------------------------------------------------------------------------------
         core::stack();
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $pth = core::get('paths')[0];
         $scp = get::{'*:'}(core::get('conf.atrScope'),Keys);
      // --------------------------------------------------------------------------------

      // cnd :: set - scope if `$val` is `scope` reference
      // --------------------------------------------------------------------------------
         if ((is::str($val)) && str($val)->is($scp))
         {
            $dat = (str($val)->is([lock,once]) ? true : $pth);
            self::$attr->scope->{$val}->$ref = $dat;
            return true;
         }
      // --------------------------------------------------------------------------------

      // set :: attr - map value
      // --------------------------------------------------------------------------------
         self::$attr = set::{$ref}(self::$attr,$val);
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: get - `devl` attribute by ref
   // -----------------------------------------------------------------------------------
      public static function get($ref,$dat=udf)
      {
      // run :: stack & test
      // --------------------------------------------------------------------------------
         core::stack();
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $rsl = get::{$ref}(self::$attr,$dat);

      // TODO !! `once` scope !!
      // --------------------------------------------------------------------------------


      // cnd :: on - undefined `$rsl` & ref is conf.*
      // --------------------------------------------------------------------------------
         if ($rsl === udf)
         {
            if (substr($ref,0,5) === 'conf.')
            { core::load(__CLASS__.'.'.$ref); }

            $rsl = get::{$ref}(self::$attr,$dat);
         }
      // --------------------------------------------------------------------------------


      // rsl :: value
      // --------------------------------------------------------------------------------
         return $rsl;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: add - extend `devl.attr` by ref; create if not exist
   // -----------------------------------------------------------------------------------
      public static function add($ref,$val)
      {
      // run :: stack & test
      // --------------------------------------------------------------------------------
         core::stack();
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $pty = get::{$ref}(self::$attr);
         $pty = (is::udf($pty) ? $val : val::of($pty)->add($val));
      // --------------------------------------------------------------------------------

      // set :: attr - map value
      // --------------------------------------------------------------------------------
         self::$attr = set::{$ref}(self::$attr,$pty);
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: rip - delete `devl` attribute by ref
   // -----------------------------------------------------------------------------------
      public static function rip($ref)
      {
      // run :: stack & test
      // --------------------------------------------------------------------------------
         core::stack();
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // set :: attr - to updated value
      // --------------------------------------------------------------------------------
         self::$attr = rip::{$ref}(self::$attr);
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: has - check if `devl` has attribute by ref
   // -----------------------------------------------------------------------------------
      public static function has($ref)
      {
      // add :: to - call-stack
      // --------------------------------------------------------------------------------
         core::stack();
      // --------------------------------------------------------------------------------

         return ((get::{$ref}(self::$attr) !== udf) ? true : false);
      }
   // -----------------------------------------------------------------------------------



   // fnc :: call - `devl` func by ref (if function name is not pre-defined)
   // -----------------------------------------------------------------------------------
      public static function __callStatic($ref, $arg)
      {
      // run :: stack & test
      // --------------------------------------------------------------------------------
         core::stack();
         self::tst($ref);
      // --------------------------------------------------------------------------------


      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $cls = __CLASS__;
         $pty = self::get($ref);
         $tpe = typeOf($pty);
      // --------------------------------------------------------------------------------


      // cnd :: type - `fnc`
      // --------------------------------------------------------------------------------
         if ($tpe === fnc)
         { return call_user_func_array($pty,$arg); }
      // --------------------------------------------------------------------------------


      // cnd :: type - `udf`
      // --------------------------------------------------------------------------------
         if ($tpe === udf)
         {
         // run :: load - extension
         // -----------------------------------------------------------------------------
            core::load("$cls.$ref");
         // -----------------------------------------------------------------------------

         // def :: vars - locals
         // -----------------------------------------------------------------------------
            $pty = self::get($ref);
            $tpe = typeOf($pty);
         // -----------------------------------------------------------------------------
         }
      // --------------------------------------------------------------------------------


      // cnd :: type - `fnc`
      // --------------------------------------------------------------------------------
         if ($tpe === fnc)
         { return call_user_func_array($pty,$arg); }
      // --------------------------------------------------------------------------------


      // def :: extension - path
      // --------------------------------------------------------------------------------
         $dir = str_replace(CWD, '', __DIR__);
         $pth = "$dir/".str_replace('.','/',$ref);
         $pth = (file_exists(CWD.$pth) ? ($pth.'/_auto.run.php') : ($pth.'.fnc.php'));
      // --------------------------------------------------------------------------------


      // run :: fail - ref
      // --------------------------------------------------------------------------------
         if ($tpe === udf)
         { $msg = "`set::{'$cls.$ref'}(function(){});`  expected from: `$pth`"; }
         else
         { $msg = "`$cls.$ref` is not a function"; }

         fail::{'fatal'}($msg);
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------
   }
// --------------------------------------------------------------------------------------

?>
