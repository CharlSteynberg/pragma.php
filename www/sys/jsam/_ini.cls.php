<?

// cls :: jsam - class definition
// --------------------------------------------------------------------------------------
   class jsam
   {
   // pty :: attr - jsam attributes
   // -----------------------------------------------------------------------------------
      private static $attr = 0;
   // -----------------------------------------------------------------------------------



   // fnc :: ini - initialize jsam
   // -----------------------------------------------------------------------------------
      public static function ini()
      {
      // set :: attr - jsam attributes object
      // --------------------------------------------------------------------------------
         self::$attr = obj(['scope'=>core::get('conf.atrScope')]);
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: set - define jsam attributes
   // -----------------------------------------------------------------------------------
      public static function tst($ref)
      {
      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $cls = __CLASS__;
         $lst = explode('.',$ref);
         $pth = core::get('paths')[0];
         $stc = core::get('stack')[1];
         $fnc = explode('::', $stc->call)[1];
         $scp = self::$attr->scope;
         $arr = [];
      // --------------------------------------------------------------------------------

      // cnd :: fail - if `className` is map's first item
      // --------------------------------------------------------------------------------
         if ($lst[0] === $cls)
         { fail::{Ref}("double reference: `$cls.$cls`"); }
      // --------------------------------------------------------------------------------

      // run :: loop - on map items
      // --------------------------------------------------------------------------------
         foreach ($lst as $itm)
         {
            $arr[] = $itm;
            $tgt = implode($arr, '.');

            if (isset($scp->bias->$tgt) && ($scp->bias->$tgt !== $pth))
            { fail::{'scope'}("`$cls.$tgt` is biased to `$pth`"); }

            if (isset($scp->lock->$tgt) && str($fnc)->is(['set','add','del']))
            { fail::{'scope'}("`$cls.$tgt` is locked"); }
         }
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: set - define jsam attributes
   // -----------------------------------------------------------------------------------
      public static function set($ref,$val)
      {
      // run :: test - `$ref`
      // --------------------------------------------------------------------------------
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $pth = core::get('paths')[0];
         $scp = get::{'*:'}(core::get('conf.atrScope'),Keys);
      // --------------------------------------------------------------------------------

      // cnd :: set - scope if `$val` is `scope` reference
      // --------------------------------------------------------------------------------
         if ((is::str($val)) && str($val)->is($scp))
         {
            $dat = (str($val)->is([lock,once]) ? true : $pth);
            self::$attr->scope->{$val}->$ref = $dat;
            return true;
         }
      // --------------------------------------------------------------------------------

      // set :: attr - map value
      // --------------------------------------------------------------------------------
         self::$attr = set::{$ref}(self::$attr,$val);
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: get - attribute
   // -----------------------------------------------------------------------------------
      public static function get($ref,$dat=udf)
      {
      // run :: test - `$ref`
      // --------------------------------------------------------------------------------
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $rsl = get::{$ref}(self::$attr,$dat);

      // TODO !! `once` scope !!
      // --------------------------------------------------------------------------------


      // cnd :: mode - devl
      // --------------------------------------------------------------------------------
         if ((MODE === 'devl') && ($rsl === udf))
         {
            $cls = __CLASS__;
            $pts = explode('.', $ref);

            if ($pts[0] === 'conf')
            { core::load("$cls.$ref"); }

            $rsl = get::{$ref}(self::$attr,$dat);
         }
      // --------------------------------------------------------------------------------


      // rsl :: value
      // --------------------------------------------------------------------------------
         return $rsl;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: add - extend attr.pty; create if not exist
   // -----------------------------------------------------------------------------------
      public static function add($ref,$val)
      {
      // run :: test - `$ref`
      // --------------------------------------------------------------------------------
         self::tst($ref);
      // --------------------------------------------------------------------------------

      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $pty = get::{$ref}(self::$attr);
         $pty = (is::udf($pty) ? $val : val::of($pty)->add($val));
      // --------------------------------------------------------------------------------

      // set :: attr - map value
      // --------------------------------------------------------------------------------
         self::$attr = set::{$ref}(self::$attr,$pty);
         return true;
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------



   // fnc :: rip - delete attribute
   // -----------------------------------------------------------------------------------
      public static function rip($ref)
      {
         self::$attr = rip::{$ref}(self::$attr);
         return true;
      }
   // -----------------------------------------------------------------------------------



   // fnc :: has - attribute
   // -----------------------------------------------------------------------------------
      public static function has($ref)
      {
         return ((get::{$ref}(self::$attr) !== udf) ? true : false);
      }
   // -----------------------------------------------------------------------------------



   // fnc :: call - statically (if function name is not pre-defined)
   // -----------------------------------------------------------------------------------
      public static function __callStatic($ref, $arg)
      {
      // run :: test - `$ref`
      // --------------------------------------------------------------------------------
         self::tst($ref);
      // --------------------------------------------------------------------------------


      // def :: vars - locals
      // --------------------------------------------------------------------------------
         $cls = __CLASS__;
         $pty = self::get($ref);
         $tpe = typeOf($pty);
      // --------------------------------------------------------------------------------


      // cnd :: type - `fnc`
      // --------------------------------------------------------------------------------
         if ($tpe === fnc)
         { return call_user_func_array($pty,$arg); }
      // --------------------------------------------------------------------------------


      // cnd :: type - `udf`
      // --------------------------------------------------------------------------------
         if ($tpe === udf)
         {
         // run :: load - extension
         // -----------------------------------------------------------------------------
            core::load("$cls.$ref");
         // -----------------------------------------------------------------------------

         // def :: vars - locals
         // -----------------------------------------------------------------------------
            $pty = self::get($ref);
            $tpe = typeOf($pty);
         // -----------------------------------------------------------------------------
         }
      // --------------------------------------------------------------------------------


      // cnd :: type - `fnc`
      // --------------------------------------------------------------------------------
         if ($tpe === fnc)
         { return call_user_func_array($pty,$arg); }
      // --------------------------------------------------------------------------------


      // def :: extension - path
      // --------------------------------------------------------------------------------
         $dir = str_replace(CWD, '', __DIR__);
         $pth = "$dir/".str_replace('.','/',$ref);
         $pth = (file_exists(CWD.$pth) ? ($pth.'/_auto.run.php') : ($pth.'.fnc.php'));
      // --------------------------------------------------------------------------------


      // run :: fail - ref
      // --------------------------------------------------------------------------------
         if ($tpe === udf)
         { $msg = "`set::{'$cls.$ref'}(function(){});`  expected from: `$pth`"; }
         else
         { $msg = "`$cls.$ref` is not a function"; }

         fail::{'fatal'}($msg);
      // --------------------------------------------------------------------------------
      }
   // -----------------------------------------------------------------------------------
   }
// --------------------------------------------------------------------------------------

?>
